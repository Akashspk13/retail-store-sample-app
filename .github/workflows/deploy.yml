name: Deploy

on:
  push:
    branches: [gitops]
    paths: ['src/**', 'deploy/helm/**']
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.changes.outputs.changed-services }}
      matrix: ${{ steps.changes.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          SERVICES=("ui" "catalog" "cart" "checkout" "orders")
          CHANGED_SERVICES=()
          
          echo "üîç Checking for changes in services..."
          
          # Check for changes in src/ or helm charts
          for service in "${SERVICES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/$service/" || \
               git diff --name-only HEAD~1 HEAD | grep -q "^deploy/helm/$service/" || \
               [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              CHANGED_SERVICES+=("$service")
              echo "‚úÖ Changes detected in: $service"
            else
              echo "‚è≠Ô∏è No changes in: $service"
            fi
          done
          
          # If manual trigger, build all services
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "üîÑ Manual trigger - building all services"
            CHANGED_SERVICES=("ui" "catalog" "cart" "checkout" "orders")
          fi
          
          # Check if we have any changes
          if [ ${#CHANGED_SERVICES[@]} -eq 0 ]; then
            echo "‚ùå No services changed"
            echo "has-changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create matrix for changed services only
          MATRIX_JSON="["
          for i in "${!CHANGED_SERVICES[@]}"; do
            if [ $i -gt 0 ]; then
              MATRIX_JSON+=","
            fi
            MATRIX_JSON+="\"${CHANGED_SERVICES[$i]}\""
          done
          MATRIX_JSON+="]"
          
          echo "changed-services=${CHANGED_SERVICES[*]}" >> $GITHUB_OUTPUT
          echo "matrix={\"service\":$MATRIX_JSON}" >> $GITHUB_OUTPUT
          echo "has-changes=true" >> $GITHUB_OUTPUT
          
          echo "üìä Services to build: ${CHANGED_SERVICES[*]}"

  build-and-push:
    name: Build and Push ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/retail-store-${{ matrix.service }}
          tags: |
            type=sha,prefix=gitops-
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./src/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image info
        run: |
          echo "IMAGE_TAGS=${{ steps.meta.outputs.tags }}" >> $GITHUB_ENV
          echo "REPO=${{ secrets.DOCKERHUB_USERNAME }}/retail-store-${{ matrix.service }}" >> $GITHUB_ENV

  update-helm:
    name: Update Helm Charts
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.has-changes == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: gitops

      - name: Update all changed services Helm values
        run: |
          CHANGED_SERVICES="${{ needs.detect-changes.outputs.changed-services }}"
          echo "üìù Updating Helm values for: ${CHANGED_SERVICES}"
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # Pull latest to avoid conflicts
          git pull origin gitops --rebase --autostash
          
          for service in ${CHANGED_SERVICES}; do
            VALUES_FILE="deploy/helm/${service}/values.yaml"
            
            if [[ -f "${VALUES_FILE}" ]]; then
              echo "üîÑ Updating ${service} Helm values..."
              
              # Get the latest image tag (gitops-<sha>)
              # Extract from previous job outputs or use commit SHA
              TAG="gitops-${GITHUB_SHA:0:7}"
              
              # Update image tag in values.yaml
              sed -i "s|tag:.*|tag: ${TAG}|g" "${VALUES_FILE}"
              
              # Also update repository if needed (uncomment if needed)
              # sed -i "s|repository:.*|repository: ${{ secrets.DOCKERHUB_USERNAME }}/retail-store-${service}|g" "${VALUES_FILE}"
              
              git add "${VALUES_FILE}"
              echo "‚úÖ Updated ${VALUES_FILE} with tag: ${TAG}"
            else
              echo "‚ö†Ô∏è Helm values file not found: ${VALUES_FILE}"
            fi
          done
          
          # Commit all changes at once
          if ! git diff --cached --quiet; then
            git commit -m "üöÄ Update Helm charts for: ${CHANGED_SERVICES} - Commit: ${GITHUB_SHA:0:7}"
            
            # Push with retry
            for i in {1..3}; do
              if git push origin gitops; then
                echo "‚úÖ Successfully pushed Helm updates"
                break
              else
                echo "‚ö†Ô∏è Push failed, attempt $i/3. Pulling and retrying..."
                git pull origin gitops --rebase
                sleep 5
              fi
            done
          else
            echo "üìù No Helm changes to commit"
          fi

      - name: Trigger ArgoCD Sync
        run: |
          echo "üîÑ Triggering ArgoCD sync..."
          # You can add ArgoCD API call here if needed
          # Example with argocd CLI (if configured):
          # argocd app sync retail-store-${{ matrix.service }} --server ${{ secrets.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_TOKEN }}
          echo "‚úÖ ArgoCD will auto-sync based on git changes"

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push, update-helm]
    if: always()
    steps:
      - name: Create deployment summary
        run: |
          echo "## üöÄ GitOps Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`gitops\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.has-changes }}" == "true" ]; then
            echo "**Services Built:** ${{ needs.detect-changes.outputs.changed-services }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "**Workflow Results:**" >> $GITHUB_STEP_SUMMARY
            echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
            
            # Add job statuses
            for job in detect-changes build-and-push update-helm; do
              result="${{ needs[job].result }}"
              if [ "$result" == "success" ]; then
                echo "| \`$job\` | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
              elif [ "$result" == "failure" ]; then
                echo "| \`$job\` | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| \`$job\` | ‚ö†Ô∏è $result |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- ArgoCD will automatically sync the updated Helm charts" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor deployment in ArgoCD UI" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **Status:** No services changed - skipping deployment" >> $GITHUB_STEP_SUMMARY
          fi